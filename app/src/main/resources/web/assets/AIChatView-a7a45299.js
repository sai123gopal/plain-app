import{d as Y,e as ee,u as te,E as ae,r as d,s as se,f as ne,h as oe,i as H,aQ as ie,V as Q,P as le,Q as R,R as ce,S as re,c as u,a as s,q as h,I as f,k as l,y as de,a$ as ue,b0 as pe,b1 as _e,o as c,F as ve,K as me,t as p,b2 as M,l as K,T as he,n as T,Z as N,j as q,b3 as z,v as fe,ap as y,m,b4 as ye,at as Ce,b5 as ge,B as be,C as ke,_ as we}from"./index-2583f876.js";import{g as F,M as Ae}from"./splitpanes.es-96eec7b1.js";import{u as Ie}from"./markdown-a075af52.js";const Me=C=>(be("data-v-c925fee4"),C=C(),ke(),C),Te={class:"page-container"},$e={class:"main"},xe={key:0,class:"date"},Ve={class:"chat-title"},De={class:"name"},Le={class:"time"},Se={class:"menu-items"},Be=["onClick","disabled"],He={slot:"headline"},Qe={key:2,class:"chat-title"},Re={class:"name"},Ke={class:"time"},Ne=["innerHTML"],qe={key:0,class:"chat-item replying"},ze={class:"chat-title"},Fe={class:"name"},Ge=["innerHTML"],Ee=["placeholder","onKeydown"],Pe={class:"btns"},Ue=["onClick"],je=Me(()=>s("md-ripple",null,null,-1)),Ze=Y({__name:"AIChatView",setup(C){const G=ee(),{t:E}=te(),P=ae(),r=d(P.params.id),i=d(""),_=d([]),g=d(!1),b=d(""),w=d(""),{app:U,urlTokenKey:j}=se(ne()),$=d(),{render:k}=Ie(U,j);function A(){return r.value==="create"}function Z(e,t){let n=!1;if(t==0)n=!0;else{const o=t>0?_.value[t-1]:null;o!=null&&M(o.createdAt)!==M(e.createdAt)&&(n=!0)}return n}A()||oe({handle:async(e,t)=>{if(t)de(E(t),"error");else{const n=[];n.push({...e.aiChat,md:await k(e.aiChat.content)});for(const o of e.aiChats)n.push({...o,md:await k(o.content)});_.value=n,await Q(),D()}},document:ue,variables:()=>({id:r.value,query:`parent_id:${r.value} sort:created_at-asc`}),appApi:!0});const{mutate:x,onDone:J}=H({document:pe,appApi:!0});function V(){!i.value||g.value||x({id:A()?"":r.value,message:i.value,isMe:!0})}J(async e=>{var n;const t=e.data.createAIChat;if(t){for(const v of t)(n=_.value)==null||n.push({...v,md:await k(v.content)});A()&&(r.value=t[0].id,ie(G,`/aichats/${r.value}`)),i.value="",g.value=!g.value,b.value="",w.value='<span class="blinking-cursor"></span>',await Q(),D()}});function D(){const e=$.value;e&&(e.scrollTop=e.scrollHeight)}const I=d(""),{mutate:O,loading:W}=H({document:_e,options:{update:e=>{var n,o;e.evict({id:e.identify({__typename:"AIChat",id:I.value})});const t=(n=_.value)==null?void 0:n.findIndex(v=>v.id===I.value);t!==null&&((o=_.value)==null||o.splice(t,1))}},appApi:!0});function X(e){I.value=e,O({query:`ids:${e}`})}const L=async e=>{e.parentId===r.value&&(b.value+=e.content,w.value=await k(b.value+'<span class="blinking-cursor"></span>'),e.finishReason==="stop"&&x({id:r.value,message:b.value,isMe:!1}))};return le(()=>{R.on("ai_chat_replied",L)}),ce(()=>{R.off("ai_chat_replied",L)}),(e,t)=>{const n=ye,o=Ce,v=ge,S=re("tooltip");return c(),u("div",Te,[s("div",$e,[h(l(Ae),{class:"chat-container",horizontal:""},{default:f(()=>[h(l(F),{size:"80"},{default:f(()=>[s("div",{class:"chat-items",ref_key:"scrollContainer",ref:$},[(c(!0),u(ve,null,me(_.value,(a,B)=>(c(),u("div",{key:a.id,class:"chat-item"},[Z(a,B)?(c(),u("div",xe,p(l(M)(a.createdAt)),1)):K("",!0),B>0?(c(),he(o,{key:1},{content:f(()=>[s("div",Se,[s("md-menu-item",{onClick:Je=>X(a.id),disabled:l(W)},[s("div",He,p(e.$t("delete_message")),1)],8,Be)])]),default:f(()=>[s("div",Ve,[s("span",De,p(e.$t(a.isMe?"me":"ai")),1),T((c(),u("span",Le,[q(p(l(z)(a.createdAt)),1)])),[[S,l(N)(a.createdAt)]]),h(n,{class:"bi bi-more"})])]),_:2},1024)):(c(),u("div",Qe,[s("span",Re,p(e.$t(a.isMe?"me":"ai")),1),T((c(),u("span",Ke,[q(p(l(z)(a.createdAt)),1)])),[[S,l(N)(a.createdAt)]])])),s("div",{class:"chat-content md-container",innerHTML:a.md},null,8,Ne)]))),128)),g.value?(c(),u("div",qe,[s("div",ze,[s("span",Fe,p(e.$t("ai")),1)]),s("div",{class:"chat-content md-container",innerHTML:w.value},null,8,Ge)])):K("",!0)],512)]),_:1}),h(l(F),{class:"chat-input",size:"12",style:{"min-height":"80px"}},{default:f(()=>[T(s("md-outlined-text-field",{class:"textarea",type:"textarea","onUpdate:modelValue":t[0]||(t[0]=a=>i.value=a),autocomplete:"off",placeholder:e.$t("chat_input_hint"),onKeydown:[y(m(V,["exact","prevent"]),["enter"]),t[1]||(t[1]=y(m(a=>i.value+=`
`,["shift","exact","prevent"]),["enter"])),t[2]||(t[2]=y(m(a=>i.value+=`
`,["ctrl","exact","prevent"]),["enter"])),t[3]||(t[3]=y(m(a=>i.value+=`
`,["alt","exact","prevent"]),["enter"])),t[4]||(t[4]=y(m(a=>i.value+=`
`,["meta","exact","prevent"]),["enter"]))]},null,40,Ee),[[fe,i.value]]),s("div",Pe,[s("button",{class:"icon-button",onClick:m(V,["stop"])},[je,h(v)],8,Ue)])]),_:1})]),_:1})])])}}});const Ye=we(Ze,[["__scopeId","data-v-c925fee4"]]);export{Ye as default};
