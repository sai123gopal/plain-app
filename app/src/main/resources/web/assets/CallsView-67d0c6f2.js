import{c as be,u as Ce,_ as Te,a as we,b as Ae}from"./list-ff7cbbcd.js";import{d as qe,a as Se,s as De,c as Ve,r as k,u as Le,B as Ie,D as Re,p as Be,C as Me,E as Qe,G as Ue,H as Ge,I as y,J as Ne,a1 as ze,K as Ee,e as i,f as t,x as d,h as l,F as q,L as p,w as _,j as R,y as Fe,t as n,A as X,M as He,N as Y,O as je,a2 as Ke,k as Oe,a3 as xe,n as S,Q as D,a4 as Je,o,R as Pe,z as Xe,a5 as Ye,T as Ze,g as We,U as et,X as Z,Y as tt,V as st,a6 as lt,a7 as at,a8 as nt,a9 as ot,Z as it,$ as ct,a0 as dt}from"./index-6d72ad8d.js";import{_ as ut}from"./call-outline-rounded-513f3eea.js";import{_ as rt}from"./Breadcrumb-2d824363.js";import{n as pt}from"./list-6498ebd9.js";import{u as _t,a as mt}from"./tags-f635763f.js";import"./vee-validate.esm-ab7e8eb7.js";const ht={class:"v-toolbar"},ft=t("md-ripple",null,null,-1),gt=t("md-ripple",null,null,-1),vt={class:"filters"},kt=["label"],yt={class:"form-label"},$t={type:"filter"},bt=["label","selected","onClick"],Ct={class:"buttons"},Tt=["onClick"],wt={class:"table-responsive"},At={class:"table"},qt=["checked","indeterminate"],St=t("th",null,"ID",-1),Dt=t("th",null,null,-1),Vt=["onClick"],Lt=["checked"],It={class:"v-center"},Rt={class:"nowrap"},Bt={class:"action-btns"},Mt=["onClick"],Qt=t("md-ripple",null,null,-1),Ut={key:0,indeterminate:"",class:"spinner-sm"},Gt=["onClick"],Nt=t("md-ripple",null,null,-1),zt=["onClick"],Et=t("md-ripple",null,null,-1),Ft={class:"nowrap"},Ht={class:"nowrap"},jt={class:"nowrap"},Kt={key:0},Ot={colspan:"10"},xt={class:"no-data-placeholder"},b=50,ss=qe({__name:"CallsView",setup(Jt){var O,x;const C=Se(),{app:W}=De(Ve()),m=k([]),B=k(),{t:M}=Le(),c=Ie({text:"",tags:[]}),u=Re.CALL,Q=Be(),U=Q.query,T=k(parseInt(((O=U.page)==null?void 0:O.toString())??"1")),r=k(Me(((x=U.q)==null?void 0:x.toString())??"")),w=k(""),{tags:A}=_t(u,r,c,async e=>{f&&e.push({name:"type",op:"",value:ie[f].toString()}),w.value=Y(e),await je(),oe()}),{addToTags:ee}=mt(u,m,A),{deleteItems:te}=be(Ke,()=>{L(),I(),y.emit("refetch_tags",u)},m),{allChecked:G,realAllChecked:V,selectRealAll:se,allCheckedAlertVisible:le,clearSelection:L,toggleAllChecked:N,toggleItemChecked:z,toggleRow:ae,total:h,checked:E}=Ce(m),{loading:ne,load:oe,refetch:I}=Qe({handle:(e,a)=>{a?Oe(M(a),"error"):e&&(m.value=e.calls.map($=>({...$,checked:!1})),h.value=e.callCount)},document:xe,variables:()=>({offset:(T.value-1)*b,limit:b,query:w.value}),appApi:!0}),f=Q.params.type,ie={incoming:1,outgoing:2,missed:3};Ue(T,e=>{f?S(C,`/calls/${f}?page=${e}&q=${D(r.value)}`):S(C,`/calls?page=${e}&q=${D(r.value)}`)});function ce(e){Z(tt,{type:u,tags:A.value,item:{key:e.id,title:"",size:0},selected:A.value.filter(a=>e.tags.some($=>$.id===a.id))})}function de(e){c.tags.includes(e)?st(c.tags,a=>a.id===e.id):c.tags.push(e)}function ue(){const e=[];for(const a of c.tags)e.push({name:"tag",op:"",value:lt.kebabCase(a.name)});c.text&&e.push({name:"text",op:"",value:c.text}),r.value=Y(e),F(),B.value.dismiss()}function F(){f?S(C,`/calls/${f}?q=${D(r.value)}`):S(C,`/calls?q=${D(r.value)}`)}const H=e=>{e.type===u&&(L(),I())},j=e=>{e.type===u&&I()};Ge(()=>{y.on("item_tags_updated",j),y.on("items_tags_updated",H)}),Ne(()=>{y.off("item_tags_updated",j),y.off("items_tags_updated",H)});function re(e){if(!e)return"";const a=[];return e.isp&&a.push(M("phone_isp_type."+e.isp)),e.city===e.province?a.push(e.city):a.push(`${e.province}${e.city}`),a.join(", ")}const K=k(""),{mutate:pe,loading:_e}=ze({document:Je,appApi:!0});function me(e){K.value=e.id,pe({number:e.number})}function he(e){Z(nt,{id:e.id,name:e.id,gql:at`
      mutation DeleteCall($query: String!) {
        deleteCalls(query: $query)
      }
    `,variables:()=>({query:`ids:${e.id}`}),appApi:!0,typeName:"Call",done:()=>{h.value--,e.tags.length&&y.emit("refetch_tags",u)}})}return(e,a)=>{const $=rt,J=ot,P=it,fe=Te,ge=we,ve=ct,ke=ut,ye=dt,$e=Ae,g=Ee("tooltip");return o(),i(q,null,[t("div",ht,[d($,{current:()=>`${e.$t("page_title.calls")} (${l(h)})`},null,8,["current"]),l(E)?(o(),i(q,{key:0},[p((o(),i("button",{class:"icon-button",onClick:a[0]||(a[0]=_(s=>l(te)(l(V),w.value),["stop"]))},[ft,d(J)])),[[g,e.$t("delete")]]),p((o(),i("button",{class:"icon-button",onClick:a[1]||(a[1]=_(s=>l(ee)(l(V),w.value),["stop"]))},[gt,d(P)])),[[g,e.$t("add_to_tags")]])],64)):R("",!0),d(fe,{ref_key:"searchInputRef",ref:B,modelValue:r.value,"onUpdate:modelValue":a[3]||(a[3]=s=>r.value=s),search:F},{filters:Fe(()=>[t("div",vt,[p(t("md-outlined-text-field",{label:e.$t("keywords"),"onUpdate:modelValue":a[2]||(a[2]=s=>c.text=s),"keyup.enter":"applyAndDoSearch"},null,8,kt),[[Pe,c.text]]),t("label",yt,n(e.$t("tags")),1),t("md-chip-set",$t,[(o(!0),i(q,null,X(l(A),s=>(o(),i("md-filter-chip",{key:s.id,label:s.name,selected:c.tags.includes(s),onClick:v=>de(s)},null,8,bt))),128))]),t("div",Ct,[t("md-filled-button",{onClick:_(ue,["stop"])},n(e.$t("search")),9,Tt)])])]),_:1},8,["modelValue"])]),d(ge,{limit:b,total:l(h),"all-checked-alert-visible":l(le),"real-all-checked":l(V),"select-real-all":l(se),"clear-selection":l(L)},null,8,["total","all-checked-alert-visible","real-all-checked","select-real-all","clear-selection"]),t("div",wt,[t("table",At,[t("thead",null,[t("tr",null,[t("th",null,[t("md-checkbox",{"touch-target":"wrapper",onChange:a[4]||(a[4]=(...s)=>l(N)&&l(N)(...s)),checked:l(G),indeterminate:!l(G)&&l(E)},null,40,qt)]),St,t("th",null,n(e.$t("name")),1),t("th",null,n(e.$t("phone_number")),1),Dt,t("th",null,n(e.$t("phone_geo")),1),t("th",null,n(e.$t("duration")),1),t("th",null,n(e.$t("type")),1),t("th",null,n(e.$t("tags")),1),t("th",null,n(e.$t("started_at")),1)])]),t("tbody",null,[(o(!0),i(q,null,X(m.value,s=>(o(),i("tr",{key:s.id,class:Xe({selected:s.checked}),onClick:_(v=>l(ae)(s),["stop"])},[t("td",null,[t("md-checkbox",{"touch-target":"wrapper",onChange:a[5]||(a[5]=(...v)=>l(z)&&l(z)(...v)),checked:s.checked},null,40,Lt)]),t("td",null,[d(ve,{id:s.id,raw:s},null,8,["id","raw"])]),t("td",null,n(s.name),1),t("td",null,[t("div",It,n(s.number),1)]),t("td",Rt,[t("div",Bt,[p((o(),i("button",{class:"icon-button",onClick:_(v=>he(s),["stop"])},[Qt,d(J)],8,Mt)),[[g,e.$t("delete")]]),l(_e)&&K.value===s.id?(o(),i("md-circular-progress",Ut)):p((o(),i("button",{key:1,class:"icon-button",onClick:_(v=>me(s),["stop"])},[Nt,d(ke)],8,Gt)),[[g,e.$t("make_a_phone_call")]]),p((o(),i("button",{class:"icon-button",onClick:_(v=>ce(s),["stop"])},[Et,d(P)],8,zt)),[[g,e.$t("add_to_tags")]])])]),t("td",null,n(re(s.geo)),1),t("td",Ft,n(l(Ye)(s.duration)),1),t("td",Ht,n(e.$t("call_type."+s.type)),1),t("td",null,[d(ye,{tags:s.tags,type:l(u)},null,8,["tags","type"])]),t("td",jt,[p((o(),i("span",null,[We(n(l(et)(s.startedAt)),1)])),[[g,l(Ze)(s.startedAt)]])])],10,Vt))),128))]),m.value.length?R("",!0):(o(),i("tfoot",Kt,[t("tr",null,[t("td",Ot,[t("div",xt,n(e.$t(l(pt)(l(ne),l(W).permissions,"READ_CALL_LOG"))),1)])])]))])]),l(h)>b?(o(),He($e,{key:0,modelValue:T.value,"onUpdate:modelValue":a[6]||(a[6]=s=>T.value=s),total:l(h),limit:b},null,8,["modelValue","total"])):R("",!0)],64)}}});export{ss as default};
