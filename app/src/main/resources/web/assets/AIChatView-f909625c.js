import{d as W,a as ee,u as te,p as ae,r as d,s as se,c as ne,i as oe,a1 as N,aN as ie,O as R,H as le,I as B,J as ce,K as re,e as u,f as n,x as h,y as f,h as l,k as de,aX as ue,aY as pe,aZ as _e,o as c,F as ve,A as me,t as v,a_ as I,j as K,M as he,L as T,T as Q,g as z,a$ as F,R as fe,al as y,w as m,b0 as ye,ap as ge,b1 as Ce,au as be,av as ke,_ as we}from"./index-6d72ad8d.js";import{g as G,M as Ae}from"./splitpanes.es-150de216.js";import{u as Me}from"./markdown-2be6c3ee.js";const Ie=g=>(be("data-v-b0708e45"),g=g(),ke(),g),Te={class:"page-container"},$e={class:"main"},xe={key:0,class:"date"},Le={class:"chat-title"},De={class:"name"},Ve={class:"time"},Se={class:"menu-items"},He=["onClick","headline","disabled"],Ne={key:2,class:"chat-title"},Re={class:"name"},Be={class:"time"},Ke=["innerHTML"],Qe={key:0,class:"chat-item replying"},ze={class:"chat-title"},Fe={class:"name"},Ge=["innerHTML"],qe=["placeholder","onKeydown"],Ue={class:"btns"},je=["onClick"],Ee=Ie(()=>n("md-ripple",null,null,-1)),Je=W({__name:"AIChatView",setup(g){const q=ee(),{t:U}=te(),j=ae(),r=d(j.params.id),i=d(""),p=d([]),C=d(!1),b=d(""),w=d(""),{app:E,urlTokenKey:J}=se(ne()),$=d(),{render:k}=Me(E,J);function A(){return r.value==="create"}function O(e,t){let s=!1;if(t==0)s=!0;else{const o=t>0?p.value[t-1]:null;o!=null&&I(o.createdAt)!==I(e.createdAt)&&(s=!0)}return s}A()||oe({handle:async(e,t)=>{if(t)de(U(t),"error");else{const s=[];s.push({...e.aiChat,md:await k(e.aiChat.content)});for(const o of e.aiChats)s.push({...o,md:await k(o.content)});p.value=s,await R(),D()}},document:ue,variables:()=>({id:r.value,query:`parent_id:${r.value} sort:created_at-asc`}),appApi:!0});const{mutate:x,onDone:P}=N({document:pe,appApi:!0});function L(){!i.value||C.value||x({id:A()?"":r.value,message:i.value,isMe:!0})}P(async e=>{var s;const t=e.data.createAIChat;if(t){for(const _ of t)(s=p.value)==null||s.push({..._,md:await k(_.content)});A()&&(r.value=t[0].id,ie(q,`/aichats/${r.value}`)),i.value="",C.value=!C.value,b.value="",w.value='<span class="blinking-cursor"></span>',await R(),D()}});function D(){const e=$.value;e&&(e.scrollTop=e.scrollHeight)}const M=d(""),{mutate:X,loading:Y}=N({document:_e,options:{update:e=>{var s,o;e.evict({id:e.identify({__typename:"AIChat",id:M.value})});const t=(s=p.value)==null?void 0:s.findIndex(_=>_.id===M.value);t!==null&&((o=p.value)==null||o.splice(t,1))}},appApi:!0});function Z(e){M.value=e,X({query:`ids:${e}`})}const V=async e=>{e.parentId===r.value&&(b.value+=e.content,w.value=await k(b.value+'<span class="blinking-cursor"></span>'),e.finishReason==="stop"&&x({id:r.value,message:b.value,isMe:!1}))};return le(()=>{B.on("ai_chat_replied",V)}),ce(()=>{B.off("ai_chat_replied",V)}),(e,t)=>{const s=ye,o=ge,_=Ce,S=re("tooltip");return c(),u("div",Te,[n("div",$e,[h(l(Ae),{class:"chat-container",horizontal:""},{default:f(()=>[h(l(G),{size:"80"},{default:f(()=>[n("div",{class:"chat-items",ref_key:"scrollContainer",ref:$},[(c(!0),u(ve,null,me(p.value,(a,H)=>(c(),u("div",{key:a.id,class:"chat-item"},[O(a,H)?(c(),u("div",xe,v(l(I)(a.createdAt)),1)):K("",!0),H>0?(c(),he(o,{key:1},{content:f(()=>[n("div",Se,[n("md-menu-item",{onClick:Oe=>Z(a.id),headline:e.$t("delete_message"),disabled:l(Y)},null,8,He)])]),default:f(()=>[n("div",Le,[n("span",De,v(e.$t(a.isMe?"me":"ai")),1),T((c(),u("span",Ve,[z(v(l(F)(a.createdAt)),1)])),[[S,l(Q)(a.createdAt)]]),h(s,{class:"bi bi-more"})])]),_:2},1024)):(c(),u("div",Ne,[n("span",Re,v(e.$t(a.isMe?"me":"ai")),1),T((c(),u("span",Be,[z(v(l(F)(a.createdAt)),1)])),[[S,l(Q)(a.createdAt)]])])),n("div",{class:"chat-content md-container",innerHTML:a.md},null,8,Ke)]))),128)),C.value?(c(),u("div",Qe,[n("div",ze,[n("span",Fe,v(e.$t("ai")),1)]),n("div",{class:"chat-content md-container",innerHTML:w.value},null,8,Ge)])):K("",!0)],512)]),_:1}),h(l(G),{class:"chat-input",size:"12",style:{"min-height":"80px"}},{default:f(()=>[T(n("md-outlined-text-field",{class:"textarea",type:"textarea","onUpdate:modelValue":t[0]||(t[0]=a=>i.value=a),autocomplete:"off",placeholder:e.$t("chat_input_hint"),onKeydown:[y(m(L,["exact","prevent"]),["enter"]),t[1]||(t[1]=y(m(a=>i.value+=`
`,["shift","exact","prevent"]),["enter"])),t[2]||(t[2]=y(m(a=>i.value+=`
`,["ctrl","exact","prevent"]),["enter"])),t[3]||(t[3]=y(m(a=>i.value+=`
`,["alt","exact","prevent"]),["enter"])),t[4]||(t[4]=y(m(a=>i.value+=`
`,["meta","exact","prevent"]),["enter"]))]},null,40,qe),[[fe,i.value]]),n("div",Ue,[n("button",{class:"icon-button",onClick:m(L,["stop"])},[Ee,h(_)],8,je)])]),_:1})]),_:1})])])}}});const Ze=we(Je,[["__scopeId","data-v-b0708e45"]]);export{Ze as default};
