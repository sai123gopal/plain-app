import{d as Y,u as Z,g as ee,h as r,s as te,i as ae,l as se,j as V,b7 as ne,aw as H,af as oe,a1 as B,ag as ie,c as d,a as s,O as le,P as ce,t as u,e as N,x as A,y as re,A as h,w as v,p as Q,Q as de,C as ue,bl as pe,bm as _e,bn as ve,S as me,o as l,m,bo as M,v as he,q as R,ap as q,V as G,bp as K,F as fe,G as ye,bq as be,ao as Ce,br as ge,H as we}from"./index-R8dLcqG_.js";import{u as ke}from"./markdown-C_We2h-B.js";const Ae=f=>(fe("data-v-4d4db71f"),f=f(),ye(),f),Me={class:"chat-container"},Ie={key:0,class:"date"},Te={class:"chat-title"},$e={class:"name"},xe={class:"time"},De={class:"menu-items"},Le=["onClick","disabled"],Se={slot:"headline"},Ve={key:2,class:"chat-title"},He={class:"name"},Be={class:"time"},Ne=["innerHTML"],Qe={key:0,class:"chat-item replying"},Re={class:"chat-title"},qe={class:"name"},Ge=["innerHTML"],Ke={class:"chat-input",style:{"min-height":"80px"}},Fe=["placeholder","onKeydown"],Pe={class:"btns"},Ue=Ae(()=>s("md-ripple",null,null,-1)),je=Y({__name:"AIChatView",setup(f){const F=Z(),{t:P}=ee(),U=de(),c=r(U.params.id),i=r(""),p=r([]),y=r(!1),b=r(""),g=r(""),{app:j,urlTokenKey:E}=te(ae()),I=r(),{render:C}=ke(j,E);function w(){return c.value==="create"}function O(e,t){let n=!1;if(t==0)n=!0;else{const o=t>0?p.value[t-1]:null;o!=null&&M(o.createdAt)!==M(e.createdAt)&&(n=!0)}return n}w()||se({handle:async(e,t)=>{if(t)ue(P(t),"error");else{const n=[];n.push({...e.aiChat,md:await C(e.aiChat.content)});for(const o of e.aiChats)n.push({...o,md:await C(o.content)});p.value=n,await H(),x()}},document:pe,variables:()=>({id:c.value,query:`parent_id:${c.value} sort:created_at-asc`}),appApi:!0});const{mutate:T,onDone:z}=V({document:_e,appApi:!0});function $(){!i.value||y.value||T({id:w()?"":c.value,message:i.value,isMe:!0})}z(async e=>{var n;const t=e.data.createAIChat;if(t){for(const _ of t)(n=p.value)==null||n.push({..._,md:await C(_.content)});w()&&(c.value=t[0].id,ne(F,`/aichats/${c.value}`)),i.value="",y.value=!y.value,b.value="",g.value='<span class="blinking-cursor"></span>',await H(),x()}});function x(){const e=I.value;e&&(e.scrollTop=e.scrollHeight)}const k=r(""),{mutate:J,loading:W}=V({document:ve,options:{update:e=>{var n,o;e.evict({id:e.identify({__typename:"AIChat",id:k.value})});const t=(n=p.value)==null?void 0:n.findIndex(_=>_.id===k.value);t!==null&&((o=p.value)==null||o.splice(t,1))}},appApi:!0});function X(e){k.value=e,J({query:`ids:${e}`})}const D=async e=>{e.parentId===c.value&&(b.value+=e.content,g.value=await C(b.value+'<span class="blinking-cursor"></span>'),e.finishReason==="stop"&&T({id:c.value,message:b.value,isMe:!1}))};return oe(()=>{B.on("ai_chat_replied",D)}),ie(()=>{B.off("ai_chat_replied",D)}),(e,t)=>{const n=be,o=Ce,_=ge,L=me("tooltip");return l(),d("div",Me,[s("div",{class:"chat-items",ref_key:"scrollContainer",ref:I},[(l(!0),d(le,null,ce(p.value,(a,S)=>(l(),d("div",{key:a.id,class:"chat-item"},[O(a,S)?(l(),d("div",Ie,u(m(M)(a.createdAt)),1)):N("",!0),S>0?(l(),he(o,{key:1},{content:R(()=>[s("div",De,[s("md-menu-item",{onClick:Ee=>X(a.id),disabled:m(W)},[s("div",Se,u(e.$t("delete_message")),1)],8,Le)])]),default:R(()=>[s("div",Te,[s("span",$e,u(e.$t(a.isMe?"me":"ai")),1),A((l(),d("span",xe,[G(u(m(K)(a.createdAt)),1)])),[[L,m(q)(a.createdAt)]]),Q(n,{class:"bi bi-more"})])]),_:2},1024)):(l(),d("div",Ve,[s("span",He,u(e.$t(a.isMe?"me":"ai")),1),A((l(),d("span",Be,[G(u(m(K)(a.createdAt)),1)])),[[L,m(q)(a.createdAt)]])])),s("div",{class:"chat-content md-container",innerHTML:a.md},null,8,Ne)]))),128)),y.value?(l(),d("div",Qe,[s("div",Re,[s("span",qe,u(e.$t("ai")),1)]),s("div",{class:"chat-content md-container",innerHTML:g.value},null,8,Ge)])):N("",!0)],512),s("div",Ke,[A(s("md-outlined-text-field",{class:"textarea",type:"textarea","onUpdate:modelValue":t[0]||(t[0]=a=>i.value=a),autocomplete:"off",placeholder:e.$t("chat_input_hint"),onKeydown:[h(v($,["exact","prevent"]),["enter"]),t[1]||(t[1]=h(v(a=>i.value+=`
`,["shift","exact","prevent"]),["enter"])),t[2]||(t[2]=h(v(a=>i.value+=`
`,["ctrl","exact","prevent"]),["enter"])),t[3]||(t[3]=h(v(a=>i.value+=`
`,["alt","exact","prevent"]),["enter"])),t[4]||(t[4]=h(v(a=>i.value+=`
`,["meta","exact","prevent"]),["enter"]))]},null,40,Fe),[[re,i.value]]),s("div",Pe,[s("button",{class:"btn-icon",onClick:v($,["stop"])},[Ue,Q(_)])])])])}}}),Je=we(je,[["__scopeId","data-v-4d4db71f"]]);export{Je as default};
