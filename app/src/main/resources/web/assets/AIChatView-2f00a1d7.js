import{d as Z,a as ee,u as te,p as ae,r as d,s as se,c as ne,i as oe,a2 as R,aQ as ie,O as B,H as le,I as K,J as ce,K as re,e as u,f as s,x as h,y as f,h as l,k as de,a$ as ue,b0 as pe,b1 as _e,o as c,F as ve,A as me,t as p,b2 as I,j as N,M as he,L as x,T as Q,g as z,b3 as F,R as fe,an as y,w as m,b4 as ye,ar as ge,b5 as Ce,aw as be,ax as ke,_ as we}from"./index-e23e99bf.js";import{g as G,M as Ae}from"./splitpanes.es-951888f8.js";import{u as Me}from"./markdown-beb3b221.js";const Ie=g=>(be("data-v-c925fee4"),g=g(),ke(),g),xe={class:"page-container"},Te={class:"main"},$e={key:0,class:"date"},Le={class:"chat-title"},De={class:"name"},Ve={class:"time"},Se={class:"menu-items"},He=["onClick","disabled"],Re={slot:"headline"},Be={key:2,class:"chat-title"},Ke={class:"name"},Ne={class:"time"},Qe=["innerHTML"],ze={key:0,class:"chat-item replying"},Fe={class:"chat-title"},Ge={class:"name"},qe=["innerHTML"],Ue=["placeholder","onKeydown"],je={class:"btns"},Ee=["onClick"],Je=Ie(()=>s("md-ripple",null,null,-1)),Oe=Z({__name:"AIChatView",setup(g){const q=ee(),{t:U}=te(),j=ae(),r=d(j.params.id),i=d(""),_=d([]),C=d(!1),b=d(""),w=d(""),{app:E,urlTokenKey:J}=se(ne()),T=d(),{render:k}=Me(E,J);function A(){return r.value==="create"}function O(e,t){let n=!1;if(t==0)n=!0;else{const o=t>0?_.value[t-1]:null;o!=null&&I(o.createdAt)!==I(e.createdAt)&&(n=!0)}return n}A()||oe({handle:async(e,t)=>{if(t)de(U(t),"error");else{const n=[];n.push({...e.aiChat,md:await k(e.aiChat.content)});for(const o of e.aiChats)n.push({...o,md:await k(o.content)});_.value=n,await B(),D()}},document:ue,variables:()=>({id:r.value,query:`parent_id:${r.value} sort:created_at-asc`}),appApi:!0});const{mutate:$,onDone:P}=R({document:pe,appApi:!0});function L(){!i.value||C.value||$({id:A()?"":r.value,message:i.value,isMe:!0})}P(async e=>{var n;const t=e.data.createAIChat;if(t){for(const v of t)(n=_.value)==null||n.push({...v,md:await k(v.content)});A()&&(r.value=t[0].id,ie(q,`/aichats/${r.value}`)),i.value="",C.value=!C.value,b.value="",w.value='<span class="blinking-cursor"></span>',await B(),D()}});function D(){const e=T.value;e&&(e.scrollTop=e.scrollHeight)}const M=d(""),{mutate:W,loading:X}=R({document:_e,options:{update:e=>{var n,o;e.evict({id:e.identify({__typename:"AIChat",id:M.value})});const t=(n=_.value)==null?void 0:n.findIndex(v=>v.id===M.value);t!==null&&((o=_.value)==null||o.splice(t,1))}},appApi:!0});function Y(e){M.value=e,W({query:`ids:${e}`})}const V=async e=>{e.parentId===r.value&&(b.value+=e.content,w.value=await k(b.value+'<span class="blinking-cursor"></span>'),e.finishReason==="stop"&&$({id:r.value,message:b.value,isMe:!1}))};return le(()=>{K.on("ai_chat_replied",V)}),ce(()=>{K.off("ai_chat_replied",V)}),(e,t)=>{const n=ye,o=ge,v=Ce,S=re("tooltip");return c(),u("div",xe,[s("div",Te,[h(l(Ae),{class:"chat-container",horizontal:""},{default:f(()=>[h(l(G),{size:"80"},{default:f(()=>[s("div",{class:"chat-items",ref_key:"scrollContainer",ref:T},[(c(!0),u(ve,null,me(_.value,(a,H)=>(c(),u("div",{key:a.id,class:"chat-item"},[O(a,H)?(c(),u("div",$e,p(l(I)(a.createdAt)),1)):N("",!0),H>0?(c(),he(o,{key:1},{content:f(()=>[s("div",Se,[s("md-menu-item",{onClick:Pe=>Y(a.id),disabled:l(X)},[s("div",Re,p(e.$t("delete_message")),1)],8,He)])]),default:f(()=>[s("div",Le,[s("span",De,p(e.$t(a.isMe?"me":"ai")),1),x((c(),u("span",Ve,[z(p(l(F)(a.createdAt)),1)])),[[S,l(Q)(a.createdAt)]]),h(n,{class:"bi bi-more"})])]),_:2},1024)):(c(),u("div",Be,[s("span",Ke,p(e.$t(a.isMe?"me":"ai")),1),x((c(),u("span",Ne,[z(p(l(F)(a.createdAt)),1)])),[[S,l(Q)(a.createdAt)]])])),s("div",{class:"chat-content md-container",innerHTML:a.md},null,8,Qe)]))),128)),C.value?(c(),u("div",ze,[s("div",Fe,[s("span",Ge,p(e.$t("ai")),1)]),s("div",{class:"chat-content md-container",innerHTML:w.value},null,8,qe)])):N("",!0)],512)]),_:1}),h(l(G),{class:"chat-input",size:"12",style:{"min-height":"80px"}},{default:f(()=>[x(s("md-outlined-text-field",{class:"textarea",type:"textarea","onUpdate:modelValue":t[0]||(t[0]=a=>i.value=a),autocomplete:"off",placeholder:e.$t("chat_input_hint"),onKeydown:[y(m(L,["exact","prevent"]),["enter"]),t[1]||(t[1]=y(m(a=>i.value+=`
`,["shift","exact","prevent"]),["enter"])),t[2]||(t[2]=y(m(a=>i.value+=`
`,["ctrl","exact","prevent"]),["enter"])),t[3]||(t[3]=y(m(a=>i.value+=`
`,["alt","exact","prevent"]),["enter"])),t[4]||(t[4]=y(m(a=>i.value+=`
`,["meta","exact","prevent"]),["enter"]))]},null,40,Ue),[[fe,i.value]]),s("div",je,[s("button",{class:"icon-button",onClick:m(L,["stop"])},[Je,h(v)],8,Ee)])]),_:1})]),_:1})])])}}});const Ze=we(Oe,[["__scopeId","data-v-c925fee4"]]);export{Ze as default};
